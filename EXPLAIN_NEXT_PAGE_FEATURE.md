# 讲解下一页功能

## 功能概述

新增的"讲解下一页"按钮可以自动跳转到下一个需要讲解的页面并开始AI讲解，方便用户快速连续阅读。

## 功能特性

### 1. 智能页码跟踪
- **最大讲解页码记录**: 系统会记录每本书已讲解到的最大页码(`maxExplainedPage`)
- **初始值设置**: 如果是第一次使用，会以当前页码作为起始值
- **持久化保存**: 讲解进度会保存到本地，重新打开文件时会恢复

### 2. 按钮功能
- **动态文本**: 按钮显示"讲解X页"，其中X是下一个要讲解的页码
- **一键操作**: 点击后自动跳转到目标页面并开始AI讲解
- **状态管理**: 按钮状态会根据是否有打开的文件自动更新

### 3. 工作流程
1. 点击"讲解下一页"按钮
2. 系统获取当前最大讲解页码
3. **直接从PDF文件渲染目标页面**（不改变当前显示）
4. 将渲染结果截图并保存到剪贴板
5. 自动发送截图到ChatGPT进行AI讲解
6. 更新最大讲解页码记录

## 技术实现

### 数据结构
页面状态现在包含以下字段：
```javascript
{
    currentPage: 27,                    // 当前页码
    lastAccessed: "2024-01-01T12:00:00.000Z",  // 最后访问时间
    maxExplainedPage: 26               // 最大讲解页码
}
```

### 核心函数

#### `updateMaxExplainedPage(pageNumber)`
更新最大讲解页码：
- 只有当新页码大于当前记录时才更新
- 自动触发按钮显示更新

#### `updateExplainNextButton()`
更新按钮显示：
- 获取当前最大讲解页码
- 如果是首次使用，用当前页码作为初始值
- 设置按钮文本为"讲解(max+1)页"

#### 讲解下一页按钮事件处理
```javascript
explainNextButton.addEventListener('click', async () => {
    // 获取下一个要讲解的页码
    const nextPageToExplain = maxExplained + 1;
    
    // 直接从PDF文件中截取指定页面，不改变当前显示
    await captureSpecificPageAndExplain(nextPageToExplain);
});
```

#### `captureSpecificPageAndExplain(pageNumber)`
核心功能函数：
- 通过PDF.js直接渲染指定页面到隐藏canvas
- 转换为高质量截图（2.0缩放）
- 保存到剪贴板并发送到ChatGPT
- 不影响当前显示的页面

## 用户界面

### 按钮位置
新按钮位于智能讲解按钮的右侧：
```
[上一页] [下一页] [智能讲解] [讲解下一页] [设置]
```

### 按钮样式
- 使用与其他按钮一致的`smart-button`样式
- 包含文本显示而非图标
- 最小宽度80px，确保文本完整显示

## 使用场景

### 快速连续阅读
- 用户想要连续讲解多个页面时，不需要手动翻页
- 避免重复讲解已经处理过的页面
- **不干扰当前阅读**: 可以在阅读某一页的同时讲解其他页面

### 进度管理
- 记录阅读进度，知道讲解到了哪一页
- 重新打开书籍时可以从上次的位置继续

### 错误恢复
- 如果用户手动跳转到其他页面，按钮仍会指向正确的下一个讲解页面
- 如果是新书或重置的书，会从当前页面开始计算

## 日志输出

功能运行时会输出详细的日志信息：
```
[Explain Next Button] 按钮文本已更新: 讲解28页
[Explain Next Button] 用户点击了讲解下一页按钮
[Explain Next Button] 准备讲解第28页
[Explain Next Button] 开始讲解第28页
[Max Explained Page] 最大讲解页码已更新到: 28
```

## 注意事项

1. **不影响显示**: 讲解功能不会改变当前显示的页面，用户可以继续阅读
2. **高质量渲染**: 使用2.0缩放比例确保截图清晰度
3. **错误处理**: 如果讲解失败，会记录错误但不影响其他功能
4. **初始化逻辑**: 首次使用时会以当前页码为基准，而不是从第1页开始
5. **页码验证**: 自动检查目标页码是否在有效范围内 